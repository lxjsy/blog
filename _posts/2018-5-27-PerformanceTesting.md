---
layout: post
title: "性能测试"
date: 2018-5-27 15:50:25 
description: "软件测试过程中的性能测试"
tag: Software Testing
---

本章学习性能测试！

### 性能
* 性能是度量系统或组件在一定约束条件下能否达到功能设计的指标

  如响应速度、精确度、内存利用率等

* 性能是基于用户需求和用户对系统操作的观点的系统外部的质量属性
* 性能对于实时系统特别关键

  实时系统必须在有限的时间内完成正确的操作
  
### 一般性能指标

* 延迟(Latency)

一个指令控制器发出数据请求的一瞬间和数据传送的一瞬间之间的时间间隔;是请求和完成操作之间拖延的时间差

* 事务处理时间(Transaction processing time)

完成一项事务所需要的运行时间，用于评价事务处理效率。通常，事务处理的时间越短，则效率越高

* 最大事务处理时间(Maximum transaction processing time)

一个很重要的性能指标，首先需要分析哪些事务耗时较多，然后再将这些事务所花费的时间分别测试出来，花费时间最多的就是最大事务处理时间
  
* 事务操作时间(Transaction operating time)

主要用来评价需要用户操作的事务处理所需要花费的时间，主要体现了用户操作方面的效率。测试事务操作时间，需要一个计时器，测试多个不同用户花费的时间，最后取平均值

* 数据库性能(Database performance )

一般包括查询、插入、删除、更新数据库等所需要的时间，由于数据库性能往往是软件系统的性能瓶颈，所以测试数据库的性能非常必要

* 最大消耗内存(The largest consumption of memory)

标示着应该配置什么级别的硬件才能运行软件，它是硬件成本的直接反映。最大消耗的内存量测试可以通过性能监视器来进行

* 资源消耗(Resource consumption)

应用消耗的内存或磁盘空间总量

* 高峰内存时间(Peak time of memory)

软件在高峰内存消耗时期所运行的时间。如果软件在高峰使用的内存和系统的总内存比较接近，软件的效率将会大大降低。所以，缩减高峰内存时间可以提高软件性能

### 网络性能指标
现在网络应用十分广泛，下面介绍几种关于网络性能的指标，如：并发用户数，响应时间，吞吐量和休眠时间等

#### Web应用的页面时间

![Webresponse](/images/ST/Performance/time.png)

页面响应时间分解为网络传输时间（N1+N2+N3+N4）和应用延迟时间（A1+A2+A3）
而应用延迟时间又可分为数据库延迟时间（A2）和应用服务器延迟时间（A1+A3）

* 响应时间(Response time)

请求做出响应所需要的时间，可分解为网络传输时间、应用延迟时间、数据库延迟时间和呈现时间等

* 呈现时间(Present time)

呈现时间取决于在客户端收到数据后呈现页面所消耗的时间

* 系统响应时间(System response time)

应用系统从请求发出开始到客户端接收到数据所消耗的时间

### 并发用户数(Concurrent users)
* 严格并发用户数

所有的用户在同一时间都做同样的事情或执行相同的操作

* 广义并发用户数

多个用户对系统发出请求或进行操作，可以相同或不同

#### 并发数评估
性能测试比较关注业务并发用户数，从业务的角度设置多少并发数合理

$$C=\frac{nL}{T}$$

C:平均的并发用户数&nbsp;&nbsp;n:登录会话的数量&nbsp;&nbsp;L:登录会话的平均长度&nbsp;&nbsp;T:考察的时间段长度

* 并发用户数峰值
$$C' \approx C + \sqrt{C}$$

#### 例题
> 一个软件系统每天约有400个用户访问。用户在一天之内有8小时内使用该系统，从登录到退出的平均时间为4小时，请计算该系统的并发用户数和并发用户的峰值各是多少？
> 
> solution
> $$C = 400 \times \frac{4}{8} = 200$$
> $$C' = 200 + 3\sqrt{200} = 242$$

### 吞吐量(Throughput)
吞吐量是指在一次性能测试过程中网络上传输数据量的总和,可以用请求数/秒或页面数/秒来衡量

#### 作用
* 协助设计性能测试场景，衡量性能测试场景是否达到了预期的设计目标
* 协助分析性能测试瓶颈

#### 吞吐量估算
吞吐量和并发用户之间有一定的关系，遇到性能瓶颈状况时，吞吐量和VU数量就不符合公式

$$F = \frac{N_{vn} \times R}{T}$$

F:吞吐量&nbsp;&nbsp;n:虚拟用户数&nbsp;&nbsp;R:每个虚拟用户发送的请求&nbsp;&nbsp;T:性能测试时间

### 性能计数器与资源利用率
性能计数器是描述服务器或操作系统性能的一些数据指标，具有监控和分析的作用，资源利用率是指各种资源的使用情况<br>
通过资源利用率的横向对比，可能发现性能的瓶颈所在，例如：A资源的使用率达到100%，而其他资源利用率都较低，则资源A很有可能是系统的瓶颈所在

### 休眠时间(Dormancy time)
休眠时间又称思考时间，是指用户请求的间隔时间<br>
在交互式系统应用中，用户不大可能持续不断的发出请求，一般模式是用户发出一个请求，等待一段时间，再发出下一个请求。因此，自动化测试模拟用户操作就必须在测试脚本中让各个操作间隔一段时间，在操作语句之间设置休眠时间的Think函数，实现两个操作之间的等待时间。休眠时间与迭代次数、并发用户数和吞吐量之间存在一定的关系

$$F = \frac{N_{vn} \times R}{T}$$
$$R = \frac{T}{T_{s}}$$

#### 思考时间
1. 首先计算出系统的并发用户数
2. 统计出系统的平均吞吐量
3. 统计出平均每个用户发出的请求数量
4. 根据公式计算出思考时间
5. 
### 性能测试(Performance testing)
* 以详细的性能需求为指导对系统的性能进行评估的测试活动
* 在一定的条件下判定应用运行时的“行为” 和支持运行的基本环境
* 用来量度处理速度、响应时间、资源消耗、吞吐量和效率等系统的特点

#### 性能测试的配置
关键的活动是判定系统或应用上有哪个类型或哪几种类型的的负载
在各种各样可选的性能测试中，我们要首先决定所需要的测试类型

### 负载测试
负载测试是通过测试应用程序在负载作用下的表现,通过增加工作量直到承受的极限包括它的极限(不只是在它的限制)<br>
负载测试具体是指负载的大小(并发用户的数量）和相关的值<br>
负载测试是模拟实际软件系统所承受的负载条件的系统负荷，通过不断加载（不断增加模拟用户数量）或其他加载方式来观察不同负载下系统响应时间和数据吞吐量，系统资源占有率（cpu和内存）等性能指标，以检验系统的行为和特性，发现系统可能存在的性能瓶颈、内存泄露和不能实现同步等问题

#### 测试方式
* 一次性加载(One-time loading)

一次性加载某个数量的用户，在预定的时间段内持续运行<br>
例如，早上上班的时间访问网站或登陆网站的时间非常集中，基本属于扁平负载模式

* 递增加载(Increasing loading)

有规律的逐渐增加用户，每秒增加一些新用户，交错上升；
借助这种负载方式的测试，容易发现性能的拐点，即性能瓶颈

* 高低突变加载

某个时间用户数量很大，突然降到很低，过一段时间，又突然加到很高，反复几次；
借助这种负载方式的测试，容易发现资源的释放和内存泄漏的问题

* 随机加载
由随机算法自动生成某个数量范围内变化的、动态的负载，这种方式可能是和实际情况最为接近的一种负载方式；
虽然不容易模拟系统运行出现的瞬间高峰期，但可以模拟系统长时间的运行过程的状态

### 压力测试
* 用于判定应用处理大量数据的能力
* 可以成功的测试服务器满负载的情况
* 除了在服务器上增加运行的应用结合客户端测试是一种额外的形式的压力测试

#### 压力测试类型
* 高负载下长时间（如24小时以上）的稳定性压力测试
* 极限负载情况下导致系统崩溃的破坏性压力测试

72小时成为微软产品压力测试的时间标志

### 软件性能测试

#### 测试类型
* 测试由我们想度量的指标驱动

响应测试，吞吐量测试

* 测试基于的资源或负载的类型

负载变化/反弹测试(Load variation/bounce testing):变化负载量度性能，反应真正负载周期性衰退和反复的典型模型<br>
标准测试(Calibration(校准)  testing)：检验系统是不是违反了强制的需求，例如政府的政策法规

* 测试对系统施加压力或找到它的极限

死锁测试(Deadlock testing)：进行容量测试检验系统是否有资源竞争，例如多个请求访问同一数据库，导致系统停止处理用户请求，由于数据库记录发生死锁

### 性能测试过程
#### 计划(Planing)
了解系统的负载情况,首先，要知道我们测试所要完成的任务，通常要确定我们选择的测试类型。和我们希望运行的测试用来测试什么——哪些指标,然后，确定应用系统的容量和负载的组成，即工作负载<br>
一旦评估的指标如事务处理时间，并发用户数，网络传输时间等等已经确定，下个步骤就是建立一个负载概况。负载的概况是为了模拟真实的环境而创建的,不但包括评估的负载大小，还包括系统的用户和构成负载的活动的概述需要被创建<br>
测试样本的大小:大多数我们想要量度的指标，例如响应时间，都是基于各种各样因素的影响，这些因素有知道的也有不了解的。这就意味着我们不能只量度一次，而是取样进行多次测试得到有意义的平均值。多大的样本是我们所需要的，有一个粗略的规则可以平衡样本大小和精度的关系<br>
网站上的用户数量受网站类型、特殊事件、季节事件的影响<br>
测试类型：负载、性能、压力

#### 记录(record)、修改(Modify)、执行(Execute)
首先模拟实际用户的操作行为，记录和回放多用户测试中事务处理的过程，自动生成测试脚本。
其次能对脚本进行修改，增加逻辑控制，完成参数化和数据关联。
参数化：使用一些列不同的值（样本）来执行相同的脚本，匹配实际用户的操作行为，反映出系统真正的负载能力。需要用参数来替换已刻录的值，即脚本参数化

#### 分析(Analyze)
负载生成器运行虚拟用户，已产生有效的、可监控的负载；
分析器帮助查看、分析和比较性能结果，使用这些图和报告，可以标识和确定应用程序中的瓶颈，并确定需要对系统进行那些更改来提高系统性能